<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢¦å¢ƒæ‚è´§é“º - Dream Grocery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+Styles+Regular&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-color: #1e293b;
            --accent-color: #f472b6;
            --crystal-color: #22d3ee;
            --valid-color: #4ade80;
            --energy-color: #a855f7;
            --gold-color: #fbbf24;
            --paper-color: #fefcf0;
            --photo-bg: #d7ccc8;
        }

        body {
            background-color: var(--bg-color);
            color: #f1f5f9;
            font-family: 'ZCOOL Styles Regular', 'Courier New', monospace;
            overflow-x: hidden;
            transition: background-color 0.5s;
            /* å¸ƒå±€è¡¥ä¸ï¼šç¡®ä¿å‚ç›´å±…ä¸­ */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        body.workshop-mode {
            --bg-color: #1e1b4b; 
            --panel-color: #312e81;
        }

        .pixel-border {
            border: 4px solid #fff;
            box-shadow: 0 -4px 0 0 #fff, 0 4px 0 0 #fff, -4px 0 0 0 #fff, 4px 0 0 0 #fff;
            background: var(--panel-color);
        }

        .dream-frame {
            background: #000;
            position: relative;
            overflow: hidden;
            border: 8px solid #334155;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; /* è¡¥ä¸ï¼šå®¹å™¨å®½åº¦ */
        }

        .dream-image { width: 100%; height: 100%; object-fit: cover; transition: opacity 1s; }

        .loading-spinner {
            width: 60px; height: 60px;
            border: 6px solid rgba(34, 211, 238, 0.2);
            border-top: 6px solid var(--crystal-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-pixel {
            padding: 8px 16px;
            background: #4f46e5;
            box-shadow: -4px 4px 0 0 #312e81;
            transition: all 0.1s;
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-pixel:active { transform: translate(-2px, 2px); box-shadow: -2px 2px 0 0 #312e81; }
        .btn-pixel.active { background: var(--accent-color); box-shadow: -4px 4px 0 0 #9d174d; }

        .typing-input {
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 2px solid var(--panel-color);
            outline: none;
            transition: border-color 0.3s;
        }
        .typing-input:focus { border-bottom-color: var(--crystal-color); }

        #tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.88);
            z-index: 200;
            display: none;
            pointer-events: auto;
        }
        
        .tutorial-highlight-element {
            position: relative !important;
            z-index: 250 !important;
            pointer-events: none;
            box-shadow: 0 0 40px var(--crystal-color) !important;
            transition: box-shadow 0.4s;
        }

        @keyframes spotlight-glow {
            0%, 100% { border-color: var(--crystal-color); box-shadow: 0 0 15px var(--crystal-color); }
            50% { border-color: #fff; box-shadow: 0 0 30px #fff; }
        }

        .spotlight {
            position: absolute;
            border: 4px solid var(--crystal-color);
            border-radius: 12px;
            z-index: 249;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            animation: spotlight-glow 2s infinite ease-in-out;
        }

        .tutorial-dialog {
            position: absolute;
            z-index: 500; 
            width: 320px;
            transition: all 0.4s;
            background: #020617 !important; 
            border: 4px solid var(--crystal-color) !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
        }
        
        #tutorial-msg {
            color: #ffffff !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-size: 1.1rem;
        }

        .card-polaroid {
            background: var(--paper-color);
            color: #1a1a1a;
            padding: 20px;
            padding-bottom: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            width: 90vw;
            max-width: 400px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: rotate(-0.5deg);
        }

        .card-image-box {
            width: 100%;
            aspect-ratio: 1/1;
            background: #000;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            overflow: hidden;
            flex-shrink: 0;
        }

        .handwriting {
            font-family: 'ZCOOL Styles Regular', cursive;
            line-height: 1.5;
            color: #2c1810;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        @keyframes medal-pop {
            0% { transform: scale(0) rotate(-20deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .medal-unlock-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .medal-unlock-overlay.show { opacity: 1; pointer-events: auto; }

        .medal-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 4px solid var(--gold-color);
            padding: 30px;
            text-align: center;
            transform: scale(0);
            animation: medal-pop 0.6s forwards cubic-bezier(0.17, 0.67, 0.83, 0.67);
            max-width: 300px;
        }

        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .heart-beat { animation: heartbeat 1s infinite; display: inline-block; color: #f472b6; }
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background-color: #ef4444; border: 2px solid white; border-radius: 50%; }

        #order-arrival-toast {
            top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            transition: transform 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #order-arrival-toast.show { transform: translateX(-50%) translateY(0); }

        .order-letter {
            background-color: var(--paper-color);
            color: #5d4037;
            padding: 30px;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.3);
        }

        .photo-frame {
            position: relative;
            background: white;
            padding: 8px;
            padding-bottom: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-frame:hover { transform: scale(1.05) rotate(2deg); }
        .photo-thumb { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
    </style>
</head>
<body class="p-4">

    <div id="intro-modal" class="fixed inset-0 z-[350] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-lg hidden">
        <div class="pixel-border max-w-xl p-8 bg-slate-900 text-slate-100 flex flex-col items-center text-center">
            <div class="text-6xl mb-6">ğŸ‘§</div>
            <h2 class="text-2xl font-bold text-pink-400 mb-4 tracking-widest">é‡è§å°æ¢¦</h2>
            <div id="intro-text-container" class="space-y-4 text-lg handwriting handwriting leading-relaxed italic text-slate-300">
                <p>â€œå˜¿ï¼Œä½ å¥½å‘€ï½ æˆ‘æ˜¯æ¢¦å¢ƒæ‚è´§é“ºçš„ä¸»ç†äººå°æ¢¦ã€‚â€</p>
                <p>â€œä½ æœ‰æ²¡æœ‰è¿‡è¿™æ ·çš„æ—¶åˆ»ï¼Ÿç™½å¤©çš„çƒ¦æ¼åƒä¸€å›¢ä¹±éº»ï¼Œå¤œé‡Œèººä¸‹æ—¶ï¼Œå¿ƒé‡Œè¿˜ç•™ç€å‡ ä¸ªå°å°çš„è¤¶çš±â€”â€”ä¹Ÿè®¸æ˜¯æ²¡åšå®Œçš„æ¢¦ï¼Œä¹Ÿè®¸æ˜¯æƒ³å¿˜åˆå¿˜ä¸æ‰çš„å°æƒ…ç»ªï¼Œåƒä¹Œäº‘ä¸€æ ·è½»è½»å‹ç€èƒ¸å£ã€‚â€</p>
                <p>â€œå…¶å®å‘€ï¼Œä¸åªæ˜¯æˆ‘ä»¬ï¼Œåœ¨æˆ‘ä½çš„å°é•‡ä¸Šï¼Œé‚£äº›å¯çˆ±çš„å°åŠ¨ç‰©é‚»å±…ä»¬ä¹Ÿæœ‰è¿™æ ·çš„è¤¶çš±ã€‚äºæ˜¯æˆ‘å¼€äº†è¿™æ ·ä¸€é—´æ‚è´§é“ºï¼Œç”¨å…ƒç´ é­”æ³•ä¸ºå¤§å®¶åˆ¶ä½œæ¢¦å¢ƒã€‚â€</p>
                <p>â€œä½ æ„¿æ„å’Œæˆ‘ä¸€èµ·åŠªåŠ›ï¼Œä¼ é€’è¿™ä»½ç¾å¥½å—ï¼Ÿâ€</p>
            </div>
            <button onclick="startOnboarding()" class="btn-pixel bg-pink-600 shadow-pink-900 mt-8 px-12 font-bold text-white text-lg">
                âœ¨ æˆ‘æ„¿æ„ï¼Œå°æ¢¦ï¼
            </button>
        </div>
    </div>

    <div id="tutorial-overlay">
        <div id="tutorial-spotlight" class="spotlight"></div>
        <div id="tutorial-dialog" class="tutorial-dialog pixel-border p-6 bg-slate-900 text-white">
            <p id="tutorial-msg" class="text-sm mb-6 handwriting italic font-bold leading-relaxed"></p>
            <div class="flex justify-between items-center border-t border-slate-700 pt-4">
                <button onclick="skipTutorial()" class="text-xs text-slate-400 hover:text-white transition-colors">æš‚æ—¶è·³è¿‡</button>
                <div class="flex gap-2">
                    <button id="tutorial-prev-btn" onclick="prevTutorialStep()" class="btn-pixel bg-slate-600 shadow-slate-800 text-[12px] py-1 px-4 font-bold hidden">ä¸Šä¸€æ­¥</button>
                    <button onclick="nextTutorialStep()" class="btn-pixel bg-cyan-600 shadow-cyan-900 text-[12px] py-1 px-6 font-bold">æ˜ç™½äº†ï¼ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>
    </div>

    <div id="medal-unlock-container" class="medal-unlock-overlay">
        <div class="medal-card pixel-border">
            <div class="text-6xl mb-4" id="medal-unlock-icon">ğŸš€</div>
            <h2 class="text-xl font-bold text-amber-400 mb-2">æˆå°±è¾¾æˆï¼</h2>
            <h3 class="text-2xl font-black text-white mb-4" id="medal-unlock-name">å‹‹ç« åç§°</h3>
            <p class="text-xs text-slate-400 italic mb-6" id="medal-unlock-reward">å¥–åŠ±å†…å®¹</p>
            <button onclick="dismissMedal()" class="btn-pixel bg-amber-600 shadow-amber-900 font-bold w-full">æ”¶ä¸‹è¿™ä»½è£èª‰</button>
        </div>
    </div>

    <div id="order-arrival-toast" class="fixed z-[90] pixel-border bg-slate-800 px-6 py-2 flex items-center gap-3 pointer-events-none">
        <span class="heart-beat">â¤ï¸</span>
        <span class="text-sm text-white">å®å’šï¼ä¸€ä½æ–°é¡¾å®¢æ­£åœ¨é—¨å£ç­‰å¾…...</span>
    </div>

    <div class="w-full max-w-6xl flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="pixel-border px-6 py-2">
            <h1 class="text-2xl font-bold tracking-tighter">ğŸª æ¢¦å¢ƒæ‚è´§é“º</h1>
        </div>
        
        <div class="mode-nav flex gap-3 p-2 bg-black/20 rounded-lg pixel-border">
            <button onclick="switchGameMode('shop')" id="nav-shop" class="btn-pixel active text-xs">ğŸ›’ ç»è¥æ¨¡å¼</button>
            <button onclick="toggleMemoryBox()" id="nav-memory" class="btn-pixel text-xs bg-rose-600 shadow-rose-900">ğŸ“® æš–å¿ƒåŒ£å­</button>
            <button onclick="switchGameMode('workshop')" id="nav-workshop" class="btn-pixel text-xs">ğŸ› ï¸ åˆ›æ„å·¥åŠ</button>
        </div>

        <div class="flex gap-4 items-center">
            <button onclick="toggleMedalWall()" id="nav-medals" class="btn-pixel bg-indigo-600 shadow-indigo-900 font-bold">ğŸ† è£èª‰</button>
            <button onclick="toggleEncy()" id="nav-ency" class="btn-pixel bg-amber-600 shadow-amber-900 font-bold">ğŸ“– ç™¾ç§‘</button>
            <div id="crystal-box" class="pixel-border px-4 py-2 text-cyan-400 font-bold min-w-[100px] text-center">
                ğŸ’ <span id="crystal-count">0</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 w-full max-w-6xl">
        
        <div class="lg:col-span-4 flex flex-col gap-4">
            <div id="order-panel" class="pixel-border p-6 flex-1 relative overflow-hidden">
                <div id="shop-left-header" class="flex justify-between items-center mb-4 border-b border-pink-900/50 pb-2">
                    <h3 class="text-pink-400 flex items-center gap-2">
                        ğŸ“‹ å§”æ‰˜ä¿¡
                        <span id="order-heart-signal" class="heart-beat hidden text-xs">â¤ï¸</span>
                    </h3>
                    <button id="order-letter-btn" onclick="showOrderLetter()" class="relative text-amber-400 hover:text-amber-300">
                        <span class="text-2xl">ğŸ’Œ</span>
                        <div id="order-unread-dot" class="notification-dot hidden"></div>
                    </button>
                </div>
                
                <div id="order-content">
                    <div id="order-box" class="min-h-[100px] italic text-slate-300 leading-relaxed text-lg font-light">æ­£åœ¨ç­‰å¾…æ–°çš„æ€å¿µ...</div>
                    <div class="mt-4">
                        <p class="text-xs text-slate-500 mb-2 uppercase font-bold tracking-tighter">Dream Key / æ ¸å¿ƒå…³é”®è¯</p>
                        <div id="target-tags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div id="workshop-left" class="hidden h-full flex flex-col gap-4">
                    <h3 class="text-indigo-400 border-b border-indigo-900/50 pb-2 font-bold flex items-center gap-2">ğŸ““ çµæ„Ÿæ‰‹è´¦</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold uppercase tracking-widest block mb-2">Dream Title / æ¢¦å¢ƒå‘½é¢˜</label>
                            <input type="text" id="ws-dream-title" class="w-full bg-slate-900 border-b border-indigo-500 p-2 text-sm focus:outline-none" placeholder="ç»™ä½ çš„æ¢¦å–ä¸ªåå­—...">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold uppercase tracking-widest block mb-2">Inspiration Source / çµæ„Ÿæ¥æº</label>
                            <textarea id="ws-personal-note" class="w-full bg-slate-900 border border-slate-700 p-2 text-sm rounded focus:border-indigo-500 focus:outline-none" rows="6" placeholder="æ­¤æ—¶æ­¤åˆ»ï¼Œä½ è„‘æµ·ä¸­æµ®ç°äº†ä»€ä¹ˆï¼Ÿ"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div id="materials-panel" class="pixel-border p-4 bg-slate-900/50">
                <div class="flex justify-between items-center mb-2 text-xs">
                    <h3 class="text-slate-400 uppercase font-bold">Materials / ç´ æåº“</h3>
                    <span class="text-slate-500"><span id="slot-indicator">0</span> Slots Selected</span>
                </div>
                <div id="unlocked-list" class="flex flex-wrap gap-1 max-h-32 overflow-y-auto pr-1"></div>
            </div>
        </div>

        <div class="lg:col-span-8 flex flex-col gap-4">
            <div id="viewport" class="pixel-border dream-frame">
                <div id="empty-view" class="text-center p-8 opacity-40">
                    <p id="empty-msg" class="mb-4 text-xl font-light">â€œæŠŠç°å®å…³åœ¨é—¨å¤–ï¼Œå¼€å§‹é€ æ¢¦å§ã€‚â€</p>
                    <div class="text-8xl">ğŸ”®</div>
                </div>

                <div id="loading-view" class="hidden flex-col items-center">
                    <div class="loading-spinner mb-4"></div>
                    <p id="loading-msg" class="text-cyan-400 animate-pulse tracking-widest text-sm">æ­£åœ¨é“¾æ¥æ„è¯†æ·±å¤„...</p>
                </div>

                <img id="dream-img" class="dream-image hidden" alt="Vision">

                <div id="report-view" class="absolute inset-0 bg-slate-950/95 hidden flex-col items-center justify-center p-4 text-center z-30 backdrop-blur-md">
                    <h2 id="report-dream-title" class="text-2xl font-bold text-amber-200 mb-2 tracking-tighter flex-shrink-0">ã€Šæ¢¦å¢ƒåç§°ã€‹</h2>
                    
                    <div class="w-full max-w-lg overflow-y-auto pr-2 mb-4 custom-scroll" style="max-height: 78%;">
                        <div class="space-y-3">
                            <div id="customer-feedback-box" class="bg-slate-900/90 p-4 rounded-lg border border-slate-700 text-left shadow-lg relative group">
                                <p class="text-[10px] text-pink-400 font-bold mb-2 uppercase tracking-widest font-mono flex justify-between">
                                    Guest Feedback / é¡¾å®¢åé¦ˆ
                                    <button onclick="speakText('customer-story')" class="opacity-0 group-hover:opacity-100 transition-opacity text-pink-400">ğŸ”Š</button>
                                </p>
                                <p id="customer-story" class="text-sm text-slate-100 italic handwriting leading-relaxed"></p>
                            </div>
                            <div class="bg-slate-900/90 p-4 rounded-lg border border-slate-700 text-left shadow-lg relative group">
                                <p id="note-label" class="text-[10px] text-cyan-400 font-bold mb-2 uppercase tracking-widest font-mono flex justify-between">
                                    Inspiration Journal / çµæ„Ÿæ‰‹è´¦
                                    <button onclick="speakText('manager-note')" class="opacity-0 group-hover:opacity-100 transition-opacity text-cyan-400">ğŸ”Š</button>
                                </p>
                                <p id="manager-note" class="text-sm text-slate-200 italic handwriting leading-relaxed"></p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 flex-shrink-0 mb-2">
                        <button onclick="showShareCard()" class="btn-pixel bg-pink-600 shadow-pink-900 px-8 font-bold text-xs uppercase">Postcard / æ˜ä¿¡ç‰‡</button>
                        <button id="finish-btn" onclick="nextCustomer()" class="btn-pixel bg-slate-700 shadow-slate-900 px-8 font-bold text-xs uppercase">Next / ç»§ç»­</button>
                    </div>
                </div>
            </div>

            <div id="input-container" class="pixel-border p-4 relative z-10">
                <div class="flex gap-4 items-end mb-3">
                    <div class="flex-1">
                        <input type="text" id="keyword-input" 
                               autocomplete="off" spellcheck="false"
                               placeholder="é€‰æ‹©ä¸‹æ–¹ç´ æå…³é”®è¯ï¼Œç©ºæ ¼åˆ†éš”..." 
                               class="w-full typing-input py-3 px-3 text-xl text-white">
                    </div>
                    <div class="flex flex-col gap-2">
                        <button id="inspire-btn" onclick="getAIInspiration()" class="btn-pixel bg-amber-600 shadow-amber-900 text-[10px] py-1">âœ¨ çµæ„Ÿ</button>
                        <button id="weave-btn" onclick="startWeave()" class="btn-pixel bg-indigo-600 shadow-indigo-900 font-bold">ğŸª„ å¼€å¯åˆ›ä½œ</button>
                    </div>
                </div>
                <div id="feedback-area" class="flex flex-wrap gap-2 min-h-[28px] items-center text-[10px] text-slate-500 italic">
                    æ­£åœ¨å¯»æ‰¾åˆé€‚çš„æ¢¦å¢ƒå¥‘æœº...
                </div>
            </div>
        </div>
    </div>

    <div id="medal-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80">
        <div class="pixel-border w-full max-w-4xl max-h-[80vh] flex flex-col bg-slate-900">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-indigo-400">ğŸ† è£èª‰æ®¿å ‚</h2>
                <button onclick="toggleMedalWall()" class="text-slate-400 font-bold">âœ• å…³é—­</button>
            </div>
            <div id="medal-wall-view" class="p-8 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <div id="letter-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="order-letter handwriting pixel-border flex flex-col shadow-2xl relative">
                <button onclick="speakText('letter-body', 'Kore')" class="absolute top-6 right-6 text-2xl text-stone-400 hover:text-stone-800 transition-colors">ğŸ”Š</button>
                <div class="flex justify-between items-start mb-8">
                    <div class="text-2xl font-bold text-stone-800">è‡´ æ‚è´§é“ºä¸»äººï¼š</div>
                    <div class="text-5xl opacity-10">âœ‰ï¸</div>
                </div>
                <div id="letter-body" class="flex-1 text-base leading-relaxed text-stone-700"></div>
                <div class="text-right mt-10">
                    <p class="text-xs opacity-50 font-bold uppercase">Requester</p>
                    <p id="letter-sender" class="font-bold text-xl text-stone-900 border-b-2 border-stone-400 inline-block"></p>
                </div>
            </div>
            <button onclick="closeLetter()" class="btn-pixel bg-stone-800 shadow-black mt-8 px-16 font-bold text-white">æ”¶å›å§”æ‰˜ä¿¡</button>
        </div>
    </div>

    <div id="memory-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="pixel-border w-full max-w-5xl max-h-[85vh] flex flex-col bg-slate-900">
            <div class="p-6 border-b border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-bold text-rose-400 flex items-center gap-2">
                    <span>ğŸ“®</span> æš–å¿ƒåŒ£å­ <small class="text-xs font-normal opacity-50 uppercase tracking-widest">Memory Album</small>
                </h2>
                <div class="flex gap-2">
                    <button onclick="toggleMemoryBox()" class="btn-pixel text-[9px] bg-slate-700 ml-4 font-bold">âœ• å…³é—­</button>
                </div>
            </div>
            <div id="memory-empty" class="p-24 text-center opacity-30 flex-1">
                <div class="text-6xl mb-4">ğŸ“¦</div>
                <p class="text-xl font-light italic text-white">å›å¿†å†Œè¿˜åœ¨ç­‰å¾…å¡«å……...</p>
            </div>
            <div id="memory-content" class="p-8 overflow-y-auto flex-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-10 hidden"></div>
        </div>
    </div>

    <div id="share-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
        <div class="flex flex-col items-center w-full h-full justify-center">
            <div class="card-polaroid pixel-border" id="capture-card">
                <div class="card-image-box">
                    <img id="share-img" class="w-full h-full object-cover" src="" alt="Dream">
                </div>
                <div class="flex-1 overflow-y-auto pr-2 custom-scroll mb-2">
                    <h3 id="card-title" class="text-xl font-bold mb-2 tracking-tighter text-stone-900 underline decoration-pink-300">ã€Šæ¢¦å¢ƒã€‹</h3>
                    <p id="card-story" class="text-[12px] text-stone-800 italic handwriting leading-relaxed"></p>
                </div>
                <div class="flex justify-between items-end border-t border-stone-200 pt-3 flex-shrink-0">
                    <div class="text-[9px] text-stone-400 font-bold uppercase tracking-tight font-mono">Dream Grocery Store<br>Collection #<span id="dream-id">0000</span></div>
                    <div id="card-tag-ui" class="text-[10px] text-stone-500 italic font-bold">â€œæ„¿ä¸–ç•Œæ¸©æŸ”å¦‚åˆâ€</div>
                </div>
            </div>
            <div class="mt-6 flex gap-6 flex-shrink-0">
                <button onclick="closeShare()" class="btn-pixel bg-slate-800 px-10">âœ• ç¦»å¼€</button>
                <button onclick="saveCard()" class="btn-pixel bg-rose-600 px-10 font-bold text-white shadow-rose-950">ğŸ’¾ çè—æ˜ä¿¡ç‰‡</button>
            </div>
        </div>
    </div>

    <div id="ency-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80">
        <div class="pixel-border w-full max-w-4xl max-h-[80vh] flex flex-col bg-slate-900">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-amber-400">ğŸ“– æ¢¦å¢ƒç´ æç™¾ç§‘</h2>
                <button onclick="toggleEncy()" class="text-slate-400 font-bold">âœ• å…³é—­</button>
            </div>
            <div id="library-view" class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            <div class="p-4 bg-black/20 flex justify-between items-center text-xs font-bold px-6">
                <span class="text-cyan-400">æŒæœ‰æ¢¦æ™¶: ğŸ’ <span id="modal-crystals">0</span></span>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 bg-white text-black px-8 py-3 pixel-border opacity-0 pointer-events-none transition-all z-[600] font-bold shadow-2xl"></div>

    <script>
        const apiKey = "AIzaSyBXEGL7CMj4W7lRQE7bRSMzN3qW8F9sNiU";

        const gameState = {
            crystals: 350,
            unlocked: ['äº‘æœµ', 'ç¹æ˜Ÿ', 'çŒ«å’ª', 'è¤ç«è™«'],
            medals: { 
                'crossDomain': false, 'contrast': false, 'soul': false, 'minimalist': false,
                'dragonRider': false, 'cozyCorner': false, 'cosmosVoyager': false,
                'deepExplorer': false, 'sweetDream': false, 'timeTraveler': false
            },
            gameMode: 'shop',
            pastDreams: [], 
            isGenerating: false,
            currentOrder: null,
            lastResult: null,
            orderIsRead: true,
            sortMode: 'time',
            tutorialStep: 0,
            library: {
                'äº‘æœµ': { icon: 'â˜ï¸', type: 'nature', size: 'huge', price: 0 },
                'ç¹æ˜Ÿ': { icon: 'â­', type: 'nature', size: 'small', price: 0 },
                'çŒ«å’ª': { icon: 'ğŸ±', type: 'creature', size: 'small', price: 0 },
                'è¤ç«è™«': { icon: 'âœ¨', type: 'creature', size: 'small', price: 0 },
                'é²¸é±¼': { icon: 'ğŸ‹', type: 'creature', size: 'huge', price: 50 },
                'æ·±æµ·': { icon: 'ğŸŒŠ', type: 'nature', size: 'huge', price: 40 },
                'æ£‰èŠ±ç³–èˆ¹': { icon: 'â›µ', type: 'artifact', size: 'huge', price: 50 },
                'ç³–æœå±±': { icon: 'â›°ï¸', type: 'nature', size: 'huge', price: 40 },
                'æ—¶é’Ÿ': { icon: 'â°', type: 'artifact', size: 'small', price: 60 },
                'æœˆäº®ç§‹åƒ': { icon: 'ğŸŒ™', type: 'artifact', size: 'huge', price: 80 },
                'è´è¶': { icon: 'ğŸ¦‹', type: 'creature', size: 'small', price: 40 },
                'æå…‰': { icon: 'ğŸŒˆ', type: 'nature', size: 'huge', price: 70 },
                'é¾™': { icon: 'ğŸ‰', type: 'creature', size: 'huge', price: 150 },
                'æ˜Ÿçƒ': { icon: 'ğŸª', type: 'nature', size: 'huge', price: 90 },
                'æµæ˜Ÿ': { icon: 'â˜„ï¸', type: 'nature', size: 'small', price: 65 },
                'æ‚¬æµ®å²›': { icon: 'ğŸï¸', type: 'nature', size: 'huge', price: 110 },
                'ä¹¦æœ¬': { icon: 'ğŸ“–', type: 'artifact', size: 'small', price: 35 },
                'èŒ¶æ¯': { icon: 'â˜•', type: 'artifact', size: 'small', price: 25 },
                'é­”æ³•æ£’': { icon: 'ğŸª„', type: 'artifact', size: 'small', price: 75 },
                'ç¯ç¬¼': { icon: 'ğŸ®', type: 'artifact', size: 'small', price: 45 },
                'è˜‘è‡': { icon: 'ğŸ„', type: 'nature', size: 'small', price: 20 },
                'ç‹¬è§’å…½': { icon: 'ğŸ¦„', type: 'creature', size: 'huge', price: 130 },
                'æ°´æ™¶çƒ': { icon: 'ğŸ”®', type: 'artifact', size: 'small', price: 85 },
                'å½©è™¹æ¡¥': { icon: 'ğŸŒ‰', type: 'nature', size: 'huge', price: 100, isHidden: true }
            }
        };

        const medalDefs = {
            'crossDomain': { name: 'è·¨åŸŸæ¢é™©å®¶', condition: 'åœ¨æ¢¦ä¸­èåˆè‡ªç„¶ä¸é€ ç‰©', reward: 'è§£é”éšè—ç´ æï¼šå½©è™¹æ¡¥', icon: 'ğŸš€' },
            'contrast': { name: 'åå·®å¤§å¸ˆ', condition: 'åŒæ—¶ä½¿ç”¨å·¨å¤§ä¸å¾®å°çš„ç´ æ', reward: 'å¥–åŠ±ï¼š50 æ¢¦æ™¶', icon: 'ğŸ”' },
            'soul': { name: 'å¿ƒçµæ•æ‰‹', condition: 'èµ‹äºˆæ— æœºç‰©ä»¥ç”Ÿå‘½æ°”æ¯', reward: 'å¥–åŠ±ï¼š30 æ¢¦æ™¶', icon: 'ğŸ’–' },
            'minimalist': { name: 'æç®€ä¸»ä¹‰è€…', condition: 'ç”¨æç®€å…ƒç´ (â‰¤2ä¸ª)è·å¾—é«˜è¯„åˆ†', reward: 'å¥–åŠ±ï¼š40 æ¢¦æ™¶', icon: 'âšª' },
            'dragonRider': { name: 'é¾™éª‘å£«', condition: 'è®©ä¼ è¯´ä¸­çš„é¾™å‡ºç°åœ¨æ¢¦å¢ƒé‡Œ', reward: 'å¥–åŠ±ï¼š60 æ¢¦æ™¶', icon: 'ğŸ‰' },
            'cozyCorner': { name: 'åˆåè§’è½', condition: 'åŒæ—¶ä½¿ç”¨ä¹¦æœ¬ä¸èŒ¶æ¯', reward: 'å¥–åŠ±ï¼š30 æ¢¦æ™¶', icon: 'ğŸ›‹ï¸' },
            'cosmosVoyager': { name: 'æ˜Ÿé™…æ—…å®¢', condition: 'æ¢ç´¢æ˜Ÿçƒä¸æµæ˜Ÿçš„å®‡å®™å¥¥ç§˜', reward: 'å¥–åŠ±ï¼š80 æ¢¦æ™¶', icon: 'ğŸ‘¨â€ğŸš€' },
            'deepExplorer': { name: 'æ·±æµ·æ¢é™©å®¶', condition: 'åœ¨æ·±æµ·ä¸­ä¸é²¸é±¼å…±èˆ', reward: 'å¥–åŠ±ï¼š50 æ¢¦æ™¶', icon: 'ğŸ”±' },
            'sweetDream': { name: 'ç”œç”œå¥½æ¢¦', condition: 'æ£‰èŠ±ç³–èˆ¹åœé åœ¨ç³–æœå±±æ—', reward: 'å¥–åŠ±ï¼š40 æ¢¦æ™¶', icon: 'ğŸ¬' },
            'treatTraveler': { name: 'æ—¶ç©ºæ—…äºº', condition: 'å°†æ—¶é’Ÿå¸¦åˆ°é¥è¿œçš„æ˜Ÿçƒ', reward: 'å¥–åŠ±ï¼š70 æ¢¦æ™¶', icon: 'â³' }
        };

        const customersList = [
            { name: "å¿§éƒçš„å°çŒ«", text: "æˆ‘æœ€è¿‘æ€»æ˜¯å¤±çœ ï¼Œèƒ½ä¸èƒ½å¸®æˆ‘åšä¸€ä¸ªæœ‰ç€è½¯ç»µç»µäº‘æœµå’Œè¤ç«è™«çš„æ¢¦ï¼Ÿæˆ‘æƒ³åœ¨æ˜Ÿå…‰ä¸‹æ‰“ä¸ªç›¹ã€‚", targets: ["äº‘æœµ", "è¤ç«è™«"] },
            { name: "è¿œæ–¹çš„é•¿é¢ˆé¹¿", text: "æˆ‘ä½åœ¨å¹²æ—±çš„è‰åŸï¼Œå¥½ä¹…æ²¡è§è¿‡æµ·æ´‹äº†ã€‚æˆ‘æ¢¦è§æå…‰åœ¨æ·±æµ·ä¸Šè·³èˆï¼Œé‚£ä¸€å®šå¾ˆå£®è§‚å§ï¼Ÿ", targets: ["æå…‰", "æ·±æµ·"] },
            { name: "è¿·è·¯çš„å°æ¾é¼ ", text: "æˆ‘åœ¨æ£®æ—é‡Œå¼„ä¸¢äº†æœ€çˆ±çš„æ¾æœã€‚æˆ‘æƒ³è¦ä¸€ä¸ªæœ‰ç€å·¨å¤§ç³–æœå±±å’Œæœˆäº®ç§‹åƒçš„æ¢¦ã€‚", targets: ["ç³–æœå±±", "æœˆäº®ç§‹åƒ"] },
            { name: "è€æ—¶é’ŸåŒ ", text: "æ—¶é—´æ»´ç­”èµ°äº†ä¸€è¾ˆå­ã€‚æˆ‘æƒ³è¦ä¸€ä¸ªæ—¶é’Ÿåœæ‘†ã€åªæœ‰é²¸é±¼æ¸¸è¿‡çš„å¯‚é™æ·±æµ·ä¹‹æ¢¦ã€‚", targets: ["æ—¶é’Ÿ", "é²¸é±¼"] },
            { name: "å°ç™½å…”å‹‡è€…", text: "æˆ‘æƒ³å˜å¼ºå¤§ï¼æˆ‘æƒ³æ¢¦è§è‡ªå·±éª‘åœ¨å·¨é¾™èƒŒä¸Šï¼Œæ‰‹é‡Œæ¡ç€é—ªé—ªå‘å…‰çš„é­”æ³•æ£’ï¼Œé£è¿‡æ¯ä¸€ç‰‡äº‘å½©ã€‚", targets: ["é¾™", "é­”æ³•æ£’", "äº‘æœµ"] },
            { name: "æ˜Ÿé™…å°ç‹ç‹¸", text: "æˆ‘è¿·è·¯æ‰åˆ°äº†åœ°çƒã€‚æˆ‘æƒ³æ¢¦è§æˆ‘å›åˆ°äº†é¥è¿œçš„æ˜Ÿçƒï¼Œçœ‹ç€æµæ˜Ÿåˆ’è¿‡å¤œç©ºï¼Œè¿˜æœ‰æˆ‘çš„ç¹æ˜Ÿæœ‹å‹ä»¬ã€‚", targets: ["æ˜Ÿçƒ", "æµæ˜Ÿ", "ç¹æ˜Ÿ"] },
            { name: "å¤±çœ çš„çŒ«å¤´é¹°", text: "æ£®æ—é‡Œçš„å¤œå¤ªåµäº†ã€‚æˆ‘æƒ³è¦ä¸€ä¸ªæœ‰ç€æ¸©æš–ç¯ç¬¼çš„å°å±‹ï¼Œååœ¨æœˆäº®ç§‹åƒä¸Šï¼Œé—»ç€èŒ¶é¦™è¯»ä¸€æœ¬åšåšçš„è¯ã€‚", targets: ["ç¯ç¬¼", "æœˆäº®ç§‹åƒ", "èŒ¶æ¯", "ä¹¦æœ¬"] },
            { name: "æ¢¦æƒ³é£ç¿”çš„å°çŒª", text: "è™½ç„¶æˆ‘æ²¡æœ‰ç¿…è†€ï¼Œä½†æˆ‘æ¢¦è§è¿‡æ‚¬æµ®åœ¨ç©ºä¸­çš„å²›å±¿ã€‚åœ¨é‚£é‡Œï¼Œäº‘æœµå¯ä»¥å½“æ•å¤´ï¼Œæˆ‘å¯ä»¥åœ¨å½©è™¹æ¡¥ä¸Šèµ›è·‘ã€‚", targets: ["æ‚¬æµ®å²›", "äº‘æœµ", "å½©è™¹æ¡¥"] },
            { name: "æ£®æ—å°é¹¿", text: "æˆ‘æƒ³å¿µä¼ è¯´ä¸­çš„ç¥ç§˜å±±è°·ã€‚æ¢¦é‡Œä¸€å®šè¦æœ‰é—ªé—ªå‘å…‰çš„è˜‘è‡ï¼Œè¿˜æœ‰ä¼ è¯´ä¸­é“¶è‰²é•¿è§’çš„ç‹¬è§’å…½ã€‚", targets: ["è˜‘è‡", "ç‹¬è§’å…½"] },
            { name: "æµæµªè¯—äºº", text: "æˆ‘çš„çµæ„Ÿæ¯ç«­äº†ã€‚è¯·ç»™æˆ‘ä¸€ä¸ªè£…æ»¡æå…‰çš„æ¢¦ï¼Œè®©æˆ‘åœ¨æ°´æ™¶çƒé‡Œå¯»æ‰¾çœŸç†ï¼Œä¼´ç€å¢¨é¦™ä¹¦å†™æ–°çš„è¯—ç¯‡ã€‚", targets: ["æå…‰", "æ°´æ™¶çƒ", "ä¹¦æœ¬"] }
        ];

        const tutorialSteps = [
            { elementId: 'nav-shop', msg: "è¿™é‡Œæ˜¯ã€ç»è¥æ¨¡å¼ã€‘ï¼Œé€šè¿‡å®Œæˆé‚»å±…ä»¬çš„è®¢å•æ¥æ”¶é›†æ¢¦æ™¶ï¼Œæ˜¯æ‚è´§é“ºçš„æ ¸å¿ƒç©æ³•ã€‚" },
            { elementId: 'nav-memory', msg: "è¿™æ˜¯ã€æš–å¿ƒåŒ£å­ã€‘ï¼Œçè—ç€æ¯ä¸€ä»½æ›¾ç»ç¼–ç»‡å‡ºçš„ç¾ä¸½æ¢¦å¢ƒæ˜ä¿¡ç‰‡ï¼Œè®°å½•ç€ä½ çš„åˆ›ä½œè¶³è¿¹ã€‚" },
            { elementId: 'nav-workshop', msg: "è¿™é‡Œæ˜¯å…¨æ–°çš„ã€åˆ›æ„å·¥åŠã€‘ï¼Œæ²¡æœ‰è®¢å•æŸç¼šï¼Œä½ å¯ä»¥å®Œå…¨æŒ‰ç…§è‡ªå·±çš„å¿ƒæ„è‡ªç”±é€ æ¢¦å¹¶æ°¸ä¹…çè—ã€‚" },
            { elementId: 'order-panel', msg: "ã€å§”æ‰˜ä¿¡ã€‘æ ç›®ä¼šå±•ç¤ºå±…æ°‘ä»¬çš„æ€å¿µä¹‹ä¿¡ï¼Œç‚¹å‡»ä¿¡å°é˜…è¯»æ•…äº‹ï¼Œäº†è§£ä»–ä»¬çš„æ¢¦å¢ƒéœ€æ±‚ã€‚" },
            { elementId: 'materials-panel', msg: "ã€ç´ æåº“ã€‘é‡Œå­˜æ”¾ç€ä½ æ‹¥æœ‰çš„æ¢¦å¢ƒç§å­ï¼Œç‚¹å‡»å®ƒä»¬å³å¯æ”¾å…¥è¾“å…¥æ¡†ï¼Œæ¯ä¸€ä¸ªéƒ½æ˜¯æ„æˆå¹»å¢ƒçš„é­”æ³•å…ƒç´ ã€‚" },
            { elementId: 'viewport', msg: "ã€é€ æ¢¦å°ã€‘æ˜¯å¥‡è¿¹å‘ç”Ÿçš„åœ°æ–¹ï¼Œä½ ç¼–ç»‡çš„ç”»é¢å°†åœ¨è¿™é‡Œé€šè¿‡AIçš„é­”åŠ›è·ƒç„¶çº¸ä¸Šã€‚" },
            { elementId: 'nav-medals', msg: "åœ¨ã€è£èª‰ã€‘æ®¿å ‚ï¼Œä½ ä½œä¸ºæ¢¦å¢ƒç»‡ç½‘è€…æ‰€è¾¾æˆçš„æ¯ä¸€ä¸ªé‡Œç¨‹ç¢‘éƒ½å°†è¢«æ°¸ä¹…é“­åˆ»ã€‚" },
            { elementId: 'nav-ency', msg: "èµ°è¿›ã€ç™¾ç§‘ã€‘ï¼Œä½ å¯ä»¥ç”¨ç§¯ç´¯çš„æ¢¦æ™¶æ¢å–æ›´å¤šç¥å¥‡çš„æ–°å¥‡ç§å­ï¼Œä¸°å¯Œä½ çš„åˆ›ä½œè‰²å½©ã€‚" },
            { elementId: 'crystal-box', msg: "æœ€åæ˜¯ã€æ¢¦æ™¶ã€‘ï¼Œå®ƒæ˜¯æ‚è´§é“ºçš„èƒ½é‡æ¥æºï¼Œé€šè¿‡å®Œæˆé«˜è´¨é‡çš„æ¢¦å¢ƒå§”æ‰˜æ¥è·å¾—å®ƒå§ã€‚" }
        ];

        // --- UI Utils ---
        function showToast(m) { const t = document.getElementById('toast'); if(t) { t.innerText = m; t.style.opacity = '1'; setTimeout(()=>t.style.opacity = '0', 2500); } }

        function updateUI() {
            const crystalEl = document.getElementById('crystal-count');
            if (crystalEl) crystalEl.innerText = gameState.crystals;

            const listEl = document.getElementById('unlocked-list');
            if (listEl) {
                listEl.innerHTML = gameState.unlocked
                    .map(k => `<span onclick="addKeyword('${k}')" class="px-2 py-0.5 bg-slate-800 text-[10px] rounded border border-slate-700 font-bold cursor-pointer hover:border-cyan-400 select-none">${gameState.library[k].icon} ${k}</span>`).join('');
            }

            const heartSignal = document.getElementById('order-heart-signal');
            if (heartSignal) heartSignal.classList.toggle('hidden', gameState.orderIsRead);

            const unreadDot = document.getElementById('order-unread-dot');
            if (unreadDot) unreadDot.classList.toggle('hidden', gameState.orderIsRead);
        }

        function addKeyword(k) {
            const input = document.getElementById('keyword-input');
            if(!input) return;
            const current = input.value.trim();
            if (current.includes(k)) return;
            input.value = current ? current + " " + k : k;
            const indicator = document.getElementById('slot-indicator');
            if(indicator) indicator.innerText = input.value.trim().split(/\s+/).length;
        }

        function resetViewport() {
            const ev = document.getElementById('empty-view');
            const lv = document.getElementById('loading-view');
            const di = document.getElementById('dream-img');
            const rv = document.getElementById('report-view');
            const ki = document.getElementById('keyword-input');
            const si = document.getElementById('slot-indicator');
            
            const wdt = document.getElementById('ws-dream-title');
            const wpn = document.getElementById('ws-personal-note');

            if(ev) ev.classList.remove('hidden');
            if(lv) lv.classList.add('hidden');
            if(di) di.classList.add('hidden');
            if(rv) rv.classList.add('hidden');
            if(ki) ki.value = "";
            if(si) si.innerText = '0';
            
            if(wdt) wdt.value = "";
            if(wpn) wpn.value = "";
        }

        // --- AI Bridge ---
        async function geminiText(prompt, systemInstruction = "") {
            // æŒ‡å‘ Gemini 1.5 Flash ç¡®ä¿ç¨³å®šæ€§
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            let retries = 0;
            while (retries < 5) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    retries++;
                    await new Promise(r => setTimeout(r, Math.pow(2, retries) * 1000));
                }
            }
            throw new Error("Gemini API Error");
        }

        async function geminiTTS(text, voice = "Kore") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: `Say gently and emotionally in Chinese: ${text}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                }
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                const base64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!base64) return;
                const audioBuffer = base64ToUint8Array(base64);
                const wavBuffer = encodeWAV(audioBuffer, 24000);
                const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);
                audio.play();
            } catch (e) { console.error(e); }
        }

        function base64ToUint8Array(base64) {
            const binaryString = window.atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes;
        }

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length);
            const view = new DataView(buffer);
            view.setUint32(0, 0x46464952, true); view.setUint32(4, 36 + samples.length, true); view.setUint32(8, 0x45564157, true); view.setUint32(12, 0x20746d66, true); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); view.setUint32(36, 0x61746164, true); view.setUint32(40, samples.length, true);
            for (let i = 0; i < samples.length; i++) view.setUint8(44 + i, samples[i]);
            return buffer;
        }

        // --- Game Core ---
        function createOrder() {
            const choice = customersList[Math.floor(Math.random()*customersList.length)];
            gameState.currentOrder = choice;
            gameState.orderIsRead = false;
            const box = document.getElementById('order-box');
            if(box) box.innerText = `ã€${choice.name}ã€‘å¯„æ¥äº†ä¸€å°æ€å¿µä¹‹ä¿¡ã€‚`;
            const tags = document.getElementById('target-tags');
            if(tags) tags.innerHTML = choice.targets.map(t => `<span class="px-2 py-1 bg-slate-800 text-[10px] rounded border border-slate-700 font-bold">${t}</span>`).join('');
            updateUI();
        }

        async function getAIInspiration() {
            const btn = document.getElementById('inspire-btn');
            if(!btn) return;
            btn.innerText = "âœ¨ æ€è€ƒä¸­..."; btn.disabled = true;
            try {
                let prompt = "";
                if(gameState.gameMode === 'shop') {
                    prompt = `é¡¾å®¢ï¼š${gameState.currentOrder.name}ï¼Œè¦æ±‚ï¼š${gameState.currentOrder.text}ã€‚ç´ æåº“ï¼š${gameState.unlocked.join('ã€')}ã€‚æŒ‘é€‰2-3ä¸ªï¼Œç©ºæ ¼åˆ†éš”è¿”å›ï¼Œä¸è¦åºŸè¯ã€‚`;
                } else {
                    prompt = `ç°åœ¨æ˜¯åˆ›æ„å·¥åŠè‡ªç”±æ¨¡å¼ã€‚æˆ‘çš„ç´ æåº“æœ‰ï¼š${gameState.unlocked.join('ã€')}ã€‚è¯·ç»™æˆ‘æ¨èä¸€ä¸ªæå…·è¯—æ„æˆ–å¥‡å¹»æ„Ÿçš„3ä¸ªç´ æç»„åˆã€‚ç›´æ¥è¿”å›ç©ºæ ¼åˆ†éš”è¯ã€‚`;
                }
                const suggestion = await geminiText(prompt, "æ¢¦å¢ƒæ‚è´§é“ºå»ºè®®å‘˜ã€‚");
                const input = document.getElementById('keyword-input');
                if(input) input.value = suggestion.trim();
                showToast("çµæ„Ÿç«èŠ±å·²é™ä¸´ï¼");
            } catch (e) { showToast("çµæ„Ÿä¸­æ–­äº†..."); }
            finally { btn.innerText = "âœ¨ çµæ„Ÿ"; btn.disabled = false; }
        }

        async function speakText(id, voice = "Kore") {
            const el = document.getElementById(id);
            if(!el) return;
            const text = el.innerText;
            if (!text) return;
            showToast("æ­£åœ¨é€šè¿‡é­”æ³•å›å“...");
            await geminiTTS(text, voice);
        }

        async function calculateAIScore(userWords) {
            const types = userWords.map(w => gameState.library[w].type);
            const sizes = userWords.map(w => gameState.library[w].size);
            let prompt = "";
            
            let sysPrompt = `ä½ æ˜¯ä¸€ä½æå…·æƒ³è±¡åŠ›çš„æ¢¦å¢ƒä¸»ç†äººã€‚
            åœ¨ä¹¦å†™åé¦ˆæ—¶ï¼Œè¯·å‚è€ƒä»¥ä¸‹åŸåˆ™ï¼š
            - ç»è¥æ¨¡å¼ä¸‹ï¼š
                1. é¡¾å®¢åé¦ˆï¼šç¬¬ä¸€äººç§°å™äº‹ï¼Œæ„Ÿæ€§ä¸”é•¿ç¯‡ï¼Œæè¿°æ¢¦ä¸­çš„æ…°è—‰ã€‚
                2. ä¸»ç†äººéšç¬”ï¼šä½œä¸ºè§‚å¯Ÿè€…ï¼Œè®°å½•é¡¾å®¢çš„æ•…äº‹å’Œä½ çš„ç¥ç¦ã€‚
            - åˆ›æ„å·¥åŠæ¨¡å¼ä¸‹ï¼ˆç§äººçµæ„Ÿæ‰‹è´¦ï¼‰ï¼š
                1. ç¦æ­¢æåŠä»»ä½•â€œé‚»å±…â€ã€â€œé¡¾å®¢â€ã€â€œè®¢å•â€æˆ–â€œç»è¥â€ã€‚
                2. å™äº‹è§†è§’ï¼šçº¯ç²¹çš„â€œè‡ªæˆ‘æ„è¯†â€ã€‚æè¿°ä½ è¿›è¡Œæ¢¦å¢ƒå®éªŒæ—¶çš„å†…å¿ƒæ³¢åŠ¨ï¼Œå¯¹ç¾å­¦çš„ç§äººè§è§£ï¼Œæˆ–åˆ›ä½œæ—¶çš„å¹»è§‰ã€‚
                3. å†…å®¹ï¼šè¿™äº›æ–‡å­—æ˜¯ä½ å†™ç»™è‡ªå·±çš„ç§˜å¯†æ—¥è®°ï¼Œå…³äºä½ å¦‚ä½•é€šè¿‡è¿™äº›ç´ ææ¢ç´¢æ„è¯†æ·±å¤„çš„è’åŸã€‚
                4. ç§°ç§°å‘¼ï¼šåªèƒ½è‡ªç§°â€œæˆ‘â€ã€‚
            - æ ‡é¢˜ï¼šçº¯æ–‡å­—ï¼Œç»ä¸è¦å¸¦ä»»ä½•ä¹¦åå·ã€‚
            - ç¦æ­¢ï¼šä¸è¦ä½¿ç”¨â€˜åæ˜ äº†...â€™ã€â€˜è±¡å¾ç€...â€™ç­‰åˆ»æ¿çš„å­¦æœ¯åˆ†æè¯æ±‡ã€‚`;

            if (gameState.gameMode === 'shop') {
                prompt = `æ¢¦å¢ƒå§”æ‰˜äººï¼š${gameState.currentOrder.name}ï¼ˆè¯‰æ±‚ï¼š${gameState.currentOrder.text}ï¼‰ã€‚ä½¿ç”¨çš„ç´ æï¼š${userWords.join('ã€')}ã€‚
                è¯·ä»¥æ­¤ç¼–ç»‡ä¸€æ®µæ²»æ„ˆé•¿æ–‡æ¡ˆã€‚
                è¿”å›æ ¼å¼ï¼š{"title": "æ ‡é¢˜", "customer_feedback": "é•¿ç¯‡æ„Ÿæ€§ç¬¬ä¸€äººç§°åé¦ˆ", "manager_note": "ä¸»ç†äººéšç¬”(è§‚å¯Ÿä¸ç¥ç¦) "}`;
            } else {
                const customTitle = document.getElementById('ws-dream-title').value || "çµæ„Ÿç¢ç‰‡";
                const customPersonalNote = document.getElementById('ws-personal-note').value || "æˆ‘åªæ˜¯æƒ³çœ‹çœ‹è¿™äº›ç¢ç‰‡æ‹¼å‡‘åœ¨ä¸€èµ·çš„æ ·å­ã€‚";
                prompt = `è¿™æ˜¯ä¸€æ¬¡ç§äººçš„æ¢¦å¢ƒç»‡é€ å®éªŒã€‚æ ‡é¢˜ï¼š${customTitle}ã€‚æˆ‘çš„åŸå§‹çµæ„Ÿï¼š${customPersonalNote}ã€‚ç´ æï¼š${userWords.join('ã€')}ã€‚
                è¯·ä¸ºæˆ‘å†™ä¸€ä»½ç§å¯†çš„â€œçµæ„Ÿæ‰‹è´¦â€ï¼Œè®°å½•æˆ‘æ­¤åˆ»å†…å¿ƒçš„è‰ºæœ¯ç‹¬ç™½ã€‚
                è¿”å›JSON: {"title": "${customTitle}", "manager_note": "çº¯ç²¹çš„è‡ªæˆ‘è‰ºæœ¯éšç¬”/ç‹¬ç™½(å­—æ•°150-200å­—)"}`;
            }

            try {
                const resultText = await geminiText(prompt, sysPrompt);
                const result = JSON.parse(resultText.replace(/```json|```/g, ""));
                let score = 0;
                
                const safeTitle = (result.title || "æœªå‘½åçš„æ¢¦").replace(/[ã€Šã€‹]/g, "");

                if (gameState.gameMode === 'shop') {
                    score = 80 + Math.floor(Math.random()*20);
                    gameState.crystals += score;
                    checkMedals(userWords, types, sizes, score);
                }
                gameState.lastResult = {
                    imageUrl: document.getElementById('dream-img').src,
                    title: safeTitle,
                    quote: gameState.gameMode === 'shop' ? `â€œ${result.customer_feedback}â€` : result.manager_note,
                    note: result.manager_note,
                    score: score,
                    isWorkshop: gameState.gameMode === 'workshop',
                    id: Math.floor(Math.random()*9000)+1000,
                    timestamp: Date.now()
                };
                gameState.pastDreams.unshift({...gameState.lastResult});
                
                const rTitle = document.getElementById('report-dream-title');
                if(rTitle) rTitle.innerText = `ã€Š${safeTitle}ã€‹`;
                
                const cfBox = document.getElementById('customer-feedback-box');
                const cStory = document.getElementById('customer-story');
                const noteLabel = document.getElementById('note-label');

                if (gameState.gameMode === 'shop') {
                    if(cfBox) cfBox.classList.remove('hidden');
                    if(cStory) cStory.innerText = `â€œ${result.customer_feedback}â€`;
                    if(noteLabel) noteLabel.innerText = "Manager's Note / ä¸»ç†äººéšç¬”";
                } else {
                    if(cfBox) cfBox.classList.add('hidden');
                    if(noteLabel) noteLabel.innerText = "Inspiration Journal / çµæ„Ÿæ‰‹è´¦";
                }
                const mNote = document.getElementById('manager-note');
                if(mNote) mNote.innerText = result.manager_note;
                
                updateUI();
                const rView = document.getElementById('report-view');
                if(rView) { rView.classList.remove('hidden'); rView.classList.add('flex'); }
            } catch (e) { calculateStaticScore(userWords); }
        }

        function checkMedals(userWords, types, sizes, score) {
            const unlockedNewMedals = [];
            if (!gameState.medals.crossDomain && types.includes('nature') && types.includes('artifact')) { gameState.medals.crossDomain = true; gameState.unlocked.push('å½©è™¹æ¡¥'); unlockedNewMedals.push('crossDomain'); }
            if (!gameState.medals.contrast && sizes.includes('huge') && sizes.includes('small')) { gameState.medals.contrast = true; gameState.crystals += 50; unlockedNewMedals.push('contrast'); }
            if (!gameState.medals.soul && types.includes('creature') && types.includes('artifact')) { gameState.medals.soul = true; gameState.crystals += 30; unlockedNewMedals.push('soul'); }
            if (!gameState.medals.minimalist && userWords.length <= 2 && score >= 90) { gameState.medals.minimalist = true; gameState.crystals += 40; unlockedNewMedals.push('minimalist'); }
            if (!gameState.medals.dragonRider && userWords.includes('é¾™')) { gameState.medals.dragonRider = true; gameState.crystals += 60; unlockedNewMedals.push('dragonRider'); }
            if (!gameState.medals.cozyCorner && userWords.includes('ä¹¦æœ¬') && userWords.includes('èŒ¶æ¯')) { gameState.medals.cozyCorner = true; gameState.crystals += 30; unlockedNewMedals.push('soul'); }
            if (!gameState.medals.cosmosVoyager && userWords.includes('æ˜Ÿçƒ') && userWords.includes('æµæ˜Ÿ')) { gameState.medals.cosmosVoyager = true; gameState.crystals += 80; unlockedNewMedals.push('cosmosVoyager'); }
            if (!gameState.medals.deepExplorer && userWords.includes('æ·±æµ·') && userWords.includes('é²¸é±¼')) { gameState.medals.deepExplorer = true; gameState.crystals += 50; unlockedNewMedals.push('deepExplorer'); }
            if (!gameState.medals.sweetDream && userWords.includes('æ£‰èŠ±ç³–èˆ¹') && userWords.includes('ç³–æœå±±')) { gameState.medals.sweetDream = true; gameState.crystals += 40; unlockedNewMedals.push('sweetDream'); }
            if (!gameState.medals.timeTraveler && userWords.includes('æ—¶é’Ÿ') && userWords.includes('æ˜Ÿçƒ')) { gameState.medals.timeTraveler = true; gameState.crystals += 70; unlockedNewMedals.push('timeTraveler'); }
            if (unlockedNewMedals.length > 0) setTimeout(() => showMedalUnlockAnimation(unlockedNewMedals[0]), 500);
        }

        function switchGameMode(m) {
            gameState.gameMode = m;
            document.body.classList.toggle('workshop-mode', m === 'workshop');
            document.querySelectorAll('.mode-nav button').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`nav-${m}`);
            if(btn) btn.classList.add('active');
            if (m === 'workshop') {
                const oc = document.getElementById('order-content');
                const slh = document.getElementById('shop-left-header');
                const wl = document.getElementById('workshop-left');
                const wb = document.getElementById('weave-btn');
                if(oc) oc.classList.add('hidden');
                if(slh) slh.classList.add('hidden');
                if(wl) wl.classList.remove('hidden');
                if(wb) wb.innerText = "ğŸª„ å¼€å¯æ°ä½œ";
                const em = document.getElementById('empty-msg');
                if(em) em.innerText = "â€œåœ¨è¿™é‡Œï¼Œéšå¿ƒæ‰€æ¬²åœ°æŒ¥æ´’ä½ çš„çµæ„Ÿå§ã€‚â€";
            } else {
                const oc = document.getElementById('order-content');
                const slh = document.getElementById('shop-left-header');
                const wl = document.getElementById('workshop-left');
                const wb = document.getElementById('weave-btn');
                if(oc) oc.classList.remove('hidden');
                if(slh) slh.classList.remove('hidden');
                if(wl) wl.classList.add('hidden');
                if(wb) wb.innerText = "ğŸª„ ç¼–ç»‡æ¢¦å¢ƒ";
                const em = document.getElementById('empty-msg');
                if(em) em.innerText = "â€œæŠŠç°å®å…³åœ¨é—¨å¤–ï¼Œå¼€å§‹é€ æ¢¦å§ã€‚â€";
                createOrder();
            }
            resetViewport();
        }

        function nextCustomer() { 
            resetViewport(); 
            if(gameState.gameMode === 'shop') {
                createOrder(); 
            }
        }

        // --- Tutorial ---
        function checkIntro() {
            const visited = localStorage.getItem('pixel_dream_shop_visited_v15');
            if (!visited) {
                const modal = document.getElementById('intro-modal');
                if(modal) modal.classList.remove('hidden');
            } else { switchGameMode('shop'); }
        }

        function startOnboarding() {
            const modal = document.getElementById('intro-modal');
            if(modal) modal.classList.add('hidden');
            const overlay = document.getElementById('tutorial-overlay');
            if(overlay) overlay.style.display = 'block';
            gameState.tutorialStep = 0;
            showTutorialStep();
        }

        function showTutorialStep() {
            document.querySelectorAll('.tutorial-highlight-element').forEach(el => el.classList.remove('tutorial-highlight-element'));
            const step = tutorialSteps[gameState.tutorialStep];
            const el = document.getElementById(step.elementId);
            if(!el) return;
            el.classList.add('tutorial-highlight-element');
            const spotlight = document.getElementById('tutorial-spotlight');
            const dialog = document.getElementById('tutorial-dialog');
            const msg = document.getElementById('tutorial-msg');
            const prevBtn = document.getElementById('tutorial-prev-btn');
            
            const rect = el.getBoundingClientRect();
            if(spotlight) {
                spotlight.style.width = `${rect.width + 16}px`; spotlight.style.height = `${rect.height + 16}px`; spotlight.style.top = `${rect.top - 8 + window.scrollY}px`; spotlight.style.left = `${rect.left - 8 + window.scrollX}px`;
            }
            if(msg) msg.innerText = step.msg;
            
            if(prevBtn) {
                if (gameState.tutorialStep > 0) prevBtn.classList.remove('hidden');
                else prevBtn.classList.add('hidden');
            }

            if(dialog) {
                const dialogWidth = 320; const dialogHeight = 220; let top = rect.bottom + 15; let left = rect.left + (rect.width / 2) - (dialogWidth / 2);
                if (top + dialogHeight > window.innerHeight) top = rect.top - dialogHeight - 15;
                if (left < 20) left = 20; if (left + dialogWidth > window.innerWidth - 20) left = window.innerWidth - dialogWidth - 20;
                dialog.style.top = `${top + window.scrollY}px`; dialog.style.left = `${left + window.scrollX}px`;
            }
        }

        function nextTutorialStep() {
            gameState.tutorialStep++;
            if (gameState.tutorialStep >= tutorialSteps.length) skipTutorial();
            else showTutorialStep();
        }

        function prevTutorialStep() {
            if (gameState.tutorialStep > 0) {
                gameState.tutorialStep--;
                showTutorialStep();
            }
        }

        function skipTutorial() {
            document.querySelectorAll('.tutorial-highlight-element').forEach(el => el.classList.remove('tutorial-highlight-element'));
            const overlay = document.getElementById('tutorial-overlay');
            if(overlay) overlay.style.display = 'none';
            localStorage.setItem('pixel_dream_shop_visited_v15', 'true');
            switchGameMode('shop');
        }

        // --- Features ---
        function showShareCard() {
            const res = gameState.lastResult;
            if (!res) return;
            const simg = document.getElementById('share-img');
            const stitle = document.getElementById('card-title');
            const sstory = document.getElementById('card-story');
            const sid = document.getElementById('dream-id');
            const stag = document.getElementById('card-tag-ui');
            if(simg) simg.src = res.imageUrl;
            if(stitle) stitle.innerText = `ã€Š${res.title}ã€‹`;
            if(sstory) sstory.innerText = res.quote ? res.quote.replace(/â€œ|â€/g, "") : "æ¯ä¸€æ®µæ¢¦å¢ƒï¼Œéƒ½æ˜¯ä¸»ç†äººä¸ºæ‚¨å‡†å¤‡çš„ä¸€ä»½å°å°å¥‡è¿¹ã€‚";
            if(sid) sid.innerText = res.id;
            if(stag) stag.innerText = res.isWorkshop ? "Personal Collection / ä¸ªäººæ‰‹è´¦" : "Customer Order / æš–å¿ƒå§”æ‰˜";
            const smodal = document.getElementById('share-modal');
            if(smodal) smodal.classList.remove('hidden');
        }

        function revisitDream(index) {
            const res = gameState.pastDreams[index];
            gameState.lastResult = res;
            showShareCard();
        }

    async function fetchImage(prompt) {
Â  Â  Â  Â  Â  Â  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
Â  Â  Â  Â  Â  Â  const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Pixel art style, high quality cozy dreamcore, soft focus, warm nostalgic colors: ${prompt}` }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } }) });
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  return `data:image/png;base64,${data.candidates[0].content.parts.find(p => p.inlineData).inlineData.data}`;
Â  Â  Â  Â  }


        function toggleEncy() { const m = document.getElementById('ency-modal'); if(m) { m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) renderEncy(); } }

        function renderEncy() {
            const mc = document.getElementById('modal-crystals'); if(mc) mc.innerText = gameState.crystals;
            const lv = document.getElementById('library-view');
            if(lv) {
                lv.innerHTML = Object.keys(gameState.library).map(w => {
                    const isU = gameState.unlocked.includes(w);
                    if(gameState.library[w].isHidden && !isU) return '';
                    return `<div class="pixel-border p-4 flex flex-col items-center ${isU?'bg-slate-800 border-green-500':'opacity-60'}">
                        <div class="text-4xl mb-2">${gameState.library[w].icon}</div>
                        <div class="font-bold text-sm mb-2">${w}</div>
                        ${isU ? '<span class="text-green-400 text-[10px] font-bold">å·²æ‹¥æœ‰</span>' : `<button onclick="buy('${w}')" class="bg-sky-700 text-[10px] px-4 py-1 mt-1 rounded shadow-lg font-bold">ğŸ’ ${gameState.library[w].price}</button>`}
                    </div>`}).join('');
            }
        }

        function buy(w) { if(gameState.crystals >= gameState.library[w].price) { gameState.crystals -= gameState.library[w].price; gameState.unlocked.push(w); updateUI(); renderEncy(); } else showToast("æ¢¦æ™¶ä¸è¶³ï¼"); }

        function closeLetter() { const m = document.getElementById('letter-modal'); if(m) m.classList.add('hidden'); }
        function closeShare() { const m = document.getElementById('share-modal'); if(m) m.classList.add('hidden'); }
        function saveCard() { showToast("å·²ä¿å­˜è¿™å¼ æ˜ä¿¡ç‰‡ã€‚"); }
        function toggleMedalWall() { const m = document.getElementById('medal-modal'); if(m) { m.classList.toggle('hidden'); if (!m.classList.contains('hidden')) renderMedalWall(); } }
        function renderMedalWall() {
            const view = document.getElementById('medal-wall-view');
            if(view) {
                view.innerHTML = Object.keys(medalDefs).map(key => {
                    const isUnlocked = gameState.medals[key]; const def = medalDefs[key];
                    return `<div class="pixel-border p-6 flex flex-col items-center text-center transition-all ${isUnlocked ? 'bg-slate-800 border-indigo-500' : 'opacity-40 grayscale'}"><div class="text-5xl mb-4">${def.icon}</div><h3 class="font-bold text-lg ${isUnlocked ? 'text-indigo-400' : 'text-slate-500'}">${def.name}</h3><p class="text-[10px] mt-2 text-slate-400 italic">${def.condition}</p>${isUnlocked ? `<div class="mt-4 px-3 py-1 bg-indigo-900/50 rounded-full text-[9px] text-indigo-300 font-bold">å·²ç‚¹äº®</div>` : '<div class="mt-4 text-[9px] text-slate-600 font-bold">å°šæœªè¾¾æˆ</div>'}</div>`;
                }).join('');
            }
        }

        function toggleMemoryBox() { const m = document.getElementById('memory-modal'); if(m) { m.classList.toggle('hidden'); if (!m.classList.contains('hidden')) renderMemoryBox(); } }
        function renderMemoryBox() {
            const content = document.getElementById('memory-content'); const empty = document.getElementById('memory-empty');
            if (gameState.pastDreams.length === 0) { if(empty) empty.classList.remove('hidden'); if(content) content.classList.add('hidden'); }
            else { if(empty) empty.classList.add('hidden'); if(content) { content.classList.remove('hidden'); content.innerHTML = gameState.pastDreams.map((d, i) => `<div class="photo-frame" onclick="revisitDream(${i})">${d.isWorkshop ? '<div class="absolute -top-2 -left-2 bg-indigo-600 text-white text-[8px] px-2 py-0.5 rounded shadow z-10">ä¸ªäººæ°ä½œ</div>' : ''}<img src="${d.imageUrl}" class="photo-thumb"><div class="text-[8px] text-stone-700 font-bold mt-2 text-center truncate px-1">${d.title}</div></div>`).join(''); } }
        }

        async function startWeave() {
            if (gameState.isGenerating) return;
            const input = document.getElementById('keyword-input'); if(!input) return;
            const inputVal = input.value.trim(); const words = inputVal.split(/\s+/).filter(w => gameState.unlocked.includes(w));
            if (words.length === 0) return showToast("éœ€è¦æ”¾å…¥ç´ æï¼");
            gameState.isGenerating = true;
            const weaveBtn = document.getElementById('weave-btn'); const ev = document.getElementById('empty-view'); const lv = document.getElementById('loading-view');
            if(weaveBtn) weaveBtn.disabled = true; if(ev) ev.classList.add('hidden'); if(lv) lv.classList.remove('hidden');
            try {
                const promptPrefix = gameState.gameMode === 'shop' ? `${gameState.currentOrder.name}'s dream:` : `A creative vision:`;
                const url = await fetchImage(`Pixel art of ${promptPrefix} ${words.join(', ')}.`);
                const dimg = document.getElementById('dream-img');
                if(dimg) { dimg.src = url; dimg.onload = () => { if(lv) lv.classList.add('hidden'); dimg.classList.remove('hidden'); calculateAIScore(words); }; }
            } catch(e) { 
                // ä¿åº•é€»è¾‘ï¼šAPI å¤±è´¥æ—¶è¿›å…¥ç¦»çº¿æ¼”ç¤ºæ¨¡å¼
                showToast("æ¢¦å¢ƒèƒ½é‡æ³¢åŠ¨ï¼Œå¼€å¯é¢„è®¾å¹»å¢ƒ...");
                calculateStaticScore(words); 
            }
            finally { gameState.isGenerating = false; if(weaveBtn) weaveBtn.disabled = false; }
        }

        function showMedalUnlockAnimation(medalId) {
            const medal = medalDefs[medalId]; const mui = document.getElementById('medal-unlock-icon'); const mun = document.getElementById('medal-unlock-name'); const mur = document.getElementById('medal-unlock-reward'); const muc = document.getElementById('medal-unlock-container');
            if(mui) mui.innerText = medal.icon; if(mun) mun.innerText = medal.name; if(mur) mur.innerText = medal.reward; if(muc) muc.classList.add('show');
        }

        function dismissMedal() { const muc = document.getElementById('medal-unlock-container'); if(muc) muc.classList.remove('show'); const rv = document.getElementById('report-view'); if(rv) { rv.classList.remove('hidden'); rv.classList.add('flex'); } }

        function calculateStaticScore(userWords) { 
    console.log("æ­£åœ¨å¯åŠ¨ä¿åº•é€»è¾‘ï¼Œæ‰‹åŠ¨å¡«å…¥æ–‡æ¡ˆ...");
    gameState.crystals += 70; 
    
    // 1. å®šä¹‰è¦æ˜¾ç¤ºçš„æ–‡å­—å†…å®¹
    const safeTitle = "æœˆå…‰ä¸‹çš„ç»¸ç¼";
    const safeFeedback = "â€œè°¢è°¢ä½ ...æˆ‘æ„Ÿè§‰é‚£äº›ç„¦è™‘çš„è¤¶çš±çœŸçš„è¢«æŠšå¹³äº†ï¼Œå°±åƒæœˆå…‰æ´’åœ¨æµ·é¢ä¸Šä¸€æ ·å¹³é™ã€‚â€";
    const safeNote = "æˆ‘åœ¨è¿™ä»½æ¢¦å¢ƒé‡ŒåŠ å…¥äº†ä¸€ä¸æ²»æ„ˆçš„å¾®é£ã€‚å³ä¾¿ä¿¡æ ‡å¾®å¼±ï¼Œè¿™ä»½å®é™ä¹Ÿå¸Œæœ›èƒ½ä¼ è¾¾ç»™ä½ ã€‚";

    gameState.lastResult = { 
        imageUrl: "https://picsum.photos/800/800?grayscale", 
        title: safeTitle, 
        quote: safeFeedback, 
        note: safeNote, 
        score: 70, 
        id: 9999, 
        timestamp: Date.now() 
    }; 
    
    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘è¿™å‡ è¡Œæ˜¯å…³é”®ï¼å®ƒä»¬è´Ÿè´£æŠŠä¸Šé¢çš„å­—â€œå†™â€åˆ°ç½‘é¡µä¸Š
    const reportTitle = document.getElementById('report-dream-title');
    const customerStory = document.getElementById('customer-story');
    const managerNote = document.getElementById('manager-note');
    const cfBox = document.getElementById('customer-feedback-box');

    if (reportTitle) reportTitle.innerText = `ã€Š${safeTitle}ã€‹`;
    if (customerStory) customerStory.innerText = safeFeedback;
    if (managerNote) managerNote.innerText = safeNote;
    if (cfBox) cfBox.classList.remove('hidden'); // ç¡®ä¿åé¦ˆæ¡†æ˜¯ä¸éšè—çš„

    // 3. æŠŠæ•°æ®å­˜å…¥åå°
    gameState.pastDreams.unshift({...gameState.lastResult}); 
    updateUI(); 
    
    // 4. è®©æ•´ä¸ªæŠ¥å‘Šé¢æ¿æ˜¾ç¤ºå‡ºæ¥
    const rv = document.getElementById('report-view'); 
    if(rv) { 
        rv.classList.remove('hidden'); 
        rv.classList.add('flex'); 
    } 
    console.log("ä¿åº•ç•Œé¢å·²å®Œæˆæ–‡å­—å¡«å…¥å¹¶å¼¹å‡º");
}

        function showOrderLetter() {
            if (!gameState.currentOrder) return;
            const lb = document.getElementById('letter-body'); const ls = document.getElementById('letter-sender'); const lm = document.getElementById('letter-modal');
            if(lb) lb.innerText = gameState.currentOrder.text; if(ls) ls.innerText = gameState.currentOrder.name; if(lm) lm.classList.remove('hidden');
            gameState.orderIsRead = true; updateUI();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const ki = document.getElementById('keyword-input');
            if(ki) { ki.addEventListener('input', (e) => { const si = document.getElementById('slot-indicator'); if(si) si.innerText = e.target.value.trim() === "" ? 0 : e.target.value.trim().split(/\s+/).length; }); }
            checkIntro();
            // æ¿€æ´»å›¾æ ‡åº“é©±åŠ¨
            if(window.lucide) lucide.createIcons();
        });

        window.addEventListener('resize', () => { const overlay = document.getElementById('tutorial-overlay'); if (overlay && overlay.style.display === 'block') showTutorialStep(); });
    </script>
</body>
</html>